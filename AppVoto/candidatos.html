<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insertar Candidato</title>
    <!-- Bootstrap CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Botón para abrir el modal de insertar Candidato-->
    <div class="container mt-5">
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#modalInsertarCandidato"
      >
        Insertar
      </button>
       <button type="button" class="btn btn-success ms-3" onclick="cargarCandidato()">Refrescar Datos</button>
    </div>

    <!-- Modal para insertar Candidato -->
    <div
      class="modal fade"
      id="modalInsertarCandidato"
      tabindex="-1"
      aria-labelledby="modalInsertarCandidatoLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalInsertarCandidatoLabel">
              Insertar Nuevo Candidato
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="insertarCandidatoForm">
              <div class="mb-3">
                <label for="CandidatoID" class="form-label">CandidatoID</label>
                <input
                  type="number"
                  class="form-control"
                  id="CandidatoID"
                  name="CandidatoID"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="userName" class="form-label">Nombre</label>
                <input
                  type="text"
                  class="form-control"
                  id="userName"
                  name="userName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="Apellido" class="form-label">Apellido</label>
                <input
                  type="text"
                  class="form-control"
                  id="Apellido"
                  name="Apellido"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="PartidoID" class="form-label">PartidoID</label>
                <input
                  type="number"
                  class="form-control"
                  id="PartidoID"
                  name="PartidoID"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="EleccionID" class="form-label">EleccionID</label>
                <input
                  type="number"
                  class="form-control"
                  id="EleccionID"
                  name="EleccionID"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="EstadoID" class="form-label">EstadoID</label>
                <input
                  type="number"
                  class="form-control"
                  id="EstadoID"
                  name="EstadoID"
                  required
                />
              </div>
              <!-- Área para mensajes (éxito/error) -->
              
              <div id="message"></div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  Insertar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Botón para abrir el modal de actualizar Candidato -->
<div class="container mt-5">
  <button
    type="button"
    class="btn btn-warning"
    data-bs-toggle="modal"
    data-bs-target="#modalActualizarCandidato"
  >
    Actualizar Candidato
  </button>
</div>

<!-- Modal para actualizar Candidato -->
<div
  class="modal fade"
  id="modalActualizarCandidato"
  tabindex="-1"
  aria-labelledby="modalActualizarCandidatoLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalActualizarCandidatoLabel">
          Actualizar Candidato
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <form id="actualizarCandidatoForm">
          <div class="mb-3">
            <label for="actualizarCandidatoID" class="form-label">CandidatoID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarCandidatoID"
              name="CandidatoID"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarUserName" class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              id="actualizarUserName"
              name="userName"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarApellido" class="form-label">Apellido</label>
            <input
              type="text"
              class="form-control"
              id="actualizarApellido"
              name="Apellido"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarPartidoID" class="form-label">PartidoID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarPartidoID"
              name="PartidoID"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarEleccionID" class="form-label">EleccionID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarEleccionID"
              name="EleccionID"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarEstadoID" class="form-label">EstadoID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarEstadoID"
              name="EstadoID"
              required
            />
          </div>         
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-warning">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
    <div class="container mt-4">
      <h3 class="text-center">Lista de Candidatos</h3>
      <table class="table table-bordered" id="tabla-Candidatos">
          <thead>
              <tr>
                  <th>CandidatoID</th>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>PartidoID</th>
                  <th>EleccionID</th>
                  <th>EstadoID</th>
              </tr>
          </thead>
          <tbody>
              <!-- Aquí se cargarán los datos dinámicamente -->
          </tbody>
      </table>
  </div>

    <!-- Bootstrap Bundle JS (con Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // Capturamos el envío del formulario
      document
        .getElementById("insertarCandidatoForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Recuperamos los datos del formulario
          const CandidatoID = document.getElementById("CandidatoID").value;
          const nombre = document.getElementById("userName").value;
          const apellido = document.getElementById("Apellido").value;
          const PartidoID = document.getElementById("PartidoID").value;
          const EleccionID = document.getElementById("EleccionID").value;
          const EstadoID = document.getElementById("EstadoID").value;
          
          
          // Preparamos el objeto de datos
          const data = {
            CandidatoID: Number(CandidatoID),
            nombre: nombre,
            apellido: apellido,
            PartidoID: Number(PartidoID),
            EleccionID: Number(EleccionID),
            EstadoID: Number(EstadoID),
            
          };

          try {
            // Llamada al endpoint que ejecuta el procedimiento almacenado
            
            const response = await fetch("http://192.168.100.10:3000/insertar-candidato", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const messageDiv = document.getElementById("message");

            if (response.ok) {
              const result = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;

              // Se puede limpiar el formulario y cerrar el modal luego de unos segundos
              setTimeout(() => {
                document.getElementById("insertarCandidatoForm").reset();
                let modalEl = document.getElementById("modalInsertarCandidato");
                let modalInstance = bootstrap.Modal.getInstance(modalEl);
                //modalInstance.hide();
                messageDiv.innerHTML = "";
              }, 2000);
            } else {
              // En caso de error, mostramos el mensaje recibido
              const error = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
          } catch (err) {
            console.error("Error al insertar Candidato:", err);
            document.getElementById("message").innerHTML =
              '<div class="alert alert-danger">Error en la conexión al servidorr.</div>';
          }
        });
    </script>
    <script>
      // Función para obtener los datos del backend
      async function cargarCandidato() {
          try {
              // Realizamos una solicitud GET al backend
              const response = await fetch('http://localhost:3000/candidatos'); // Reemplazar con la URL correcta
              const Candidatos = await response.json();
  
              // Referencia al cuerpo de la tabla
              const tabla = document.querySelector('#tabla-Candidatos tbody');
              tabla.innerHTML = ''; // Limpiamos la tabla antes de llenarla
  
              // Iteramos sobre los Candidatos y agregamos filas a la tabla
              Candidatos.forEach(Candidato => {
                  const fila = `
                      <tr>
                          <td>${Candidato.CANDIDATO_ID}</td>
                          <td>${Candidato.NOMBRE}</td>
                          <td>${Candidato.APELLIDO}</td>
                          <td>${Candidato.PARTIDO_ID}</td>
                          <td>${Candidato.ELECCION_ID}</td>
                          <td>${Candidato.ESTADO_ID}</td>
                          <td>
                              <button class="btn btn-danger" onclick="eliminarCandidato(${Candidato.CANDIDATO_ID})">Eliminar</button>
                          </td>
                      </tr>
                  `;
                  tabla.innerHTML += fila;
              });
          } catch (error) {
              console.error('Error al cargar Candidatos:', error);
          }
      }
  
      // Función para eliminar un Candidato
      async function eliminarCandidato(CandidatoID) {
          if (confirm('¿Estás seguro de que quieres eliminar este Candidato?')) {
              try {
                  const response = await fetch(`http://localhost:3000/eliminar-candidato/${CandidatoID}`, {
                      method: 'DELETE',
                  });
  
                  if (response.ok) {
                      alert('Candidato eliminado exitosamente.');
                      cargarCandidato(); // Refrescar la tabla después de eliminar
                  } else {
                      alert('Error al eliminar Candidato seleccionado.');
                  }
              } catch (err) {
                  console.error('Error al eliminar Candidato:', err);
                  alert('Error al eliminar Candidato.');
              }
          }
      }
  
      // Cargar los Candidatos automáticamente al cargar la página
      window.onload = cargarCandidato;
  </script>
  <script>
    // Capturamos el envío del formulario para actualizar Candidato
    document
        .getElementById("actualizarCandidatoForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();

            const CandidatoID = document.getElementById("actualizarCandidatoID").value;
            const nombre = document.getElementById("actualizarUserName").value;
            const apellido = document.getElementById("actualizarApellido").value;
            const PartidoID = document.getElementById("actualizarPartidoID").value;
            const EleccionID = document.getElementById("actualizarEleccionID").value;
            const EstadoID = document.getElementById("actualizarEstadoID").value;

            const data = {
                CandidatoID: Number(CandidatoID),
                nombre: nombre,
                apellido: apellido,
                PartidoID: Number(PartidoID),
                EleccionID: Number(EleccionID),
                EstadoID: Number(EstadoID),
            };

            try {
                const response = await fetch("http://localhost:3000/actualizar-candidato", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    alert("Candidato actualizado correctamente.");
                    document.getElementById("actualizarCandidatoForm").reset();
                    let modalEl = document.getElementById("modalActualizarCandidato");
                    let modalInstance = bootstrap.Modal.getInstance(modalEl);
                    modalInstance.hide();
                    cargarCandidato(); // Refrescar la tabla de Candidatos
                } else {
                    const error = await response.json();
                    alert(error.message);
                }
            } catch (err) {
                console.error("Error al actualizar Candidato:", err);
                alert("Error en la conexión al servidor.");
            }
        });
</script>
  </body>
</html>
