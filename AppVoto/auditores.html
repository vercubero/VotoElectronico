<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insertar Auditor</title>
    <!-- Bootstrap CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Botón para abrir el modal de insertar Auditor-->
    <div class="container mt-5">
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#modalInsertarAuditor"
      >
        Insertar
      </button>
       <button type="button" class="btn btn-success ms-3" onclick="cargarAuditores()">Refrescar Datos</button>
    </div>

    <!-- Modal para insertar Auditor -->
    <div
      class="modal fade"
      id="modalInsertarAuditor"
      tabindex="-1"
      aria-labelledby="modalInsertarAuditorLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalInsertarAuditorLabel">
              Insertar Nuevo Auditor
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="insertarAuditorForm">
              <div class="mb-3">
                <label for="userName" class="form-label">Nombre</label>
                <input
                  type="text"
                  class="form-control"
                  id="userName"
                  name="userName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="Apellido" class="form-label">Apellido</label>
                <input
                  type="text"
                  class="form-control"
                  id="Apellido"
                  name="Apellido"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="telefono" class="form-label">Telefono</label>
                <input
                  type="text"
                  class="form-control"
                  id="telefono"
                  name="telefono"
                  required
                />
              </div>
              <!-- Área para mensajes (éxito/error) -->
              
              <div id="message"></div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  Insertar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Botón para abrir el modal de actualizar Auditor -->
<div class="container mt-5">
  <button
    type="button"
    class="btn btn-warning"
    data-bs-toggle="modal"
    data-bs-target="#modalActualizarAuditor"
  >
    Actualizar Auditor
  </button>
</div>

<!-- Modal para actualizar Auditor -->
<div
  class="modal fade"
  id="modalActualizarAuditor"
  tabindex="-1"
  aria-labelledby="modalActualizarAuditorLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalActualizarAuditorLabel">
          Actualizar Auditor
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <form id="actualizarAuditorForm">
          <div class="mb-3">
            <label for="actualizarAuditorId" class="form-label">AuditorID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarAuditorId"
              name="AuditorId"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarUserName" class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              id="actualizarUserName"
              name="userName"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarApellido" class="form-label">Apellido</label>
            <input
              type="text"
              class="form-control"
              id="actualizarApellido"
              name="Apellido"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="actualizarEmail"
              name="email"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizartelefono" class="form-label">Telefono</label>
            <input
              type="number"
              class="form-control"
              id="actualizartelefono"
              name="telefono"
              required
            />
          </div>          
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-warning">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
    <div class="container mt-4">
      <h3 class="text-center">Lista de Auditores</h3>
      <table class="table table-bordered" id="tabla-Auditors">
          <thead>
              <tr>
                  <th>AuditorID</th>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Email</th>
                  <th>Telefono</th>
              </tr>
          </thead>
          <tbody>
              <!-- Aquí se cargarán los datos dinámicamente -->
          </tbody>
      </table>
  </div>

    <!-- Bootstrap Bundle JS (con Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Capturamos el envío del formulario
      document
        .getElementById("insertarAuditorForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Recuperamos los datos del formulario
          const nombre = document.getElementById("userName").value;
          const apellido = document.getElementById("Apellido").value;
          const email = document.getElementById("email").value;
          const telefono = document.getElementById("telefono").value;
          
          
          // Preparamos el objeto de datos
          const data = {
            
            nombre: nombre,
            apellido: apellido,
            email: email,
            telefono: telefono,
            
            
          };

          try {
            // Llamada al endpoint que ejecuta el procedimiento almacenado
            
            const response = await fetch("http://192.168.100.10:3000/insertar-auditor", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const messageDiv = document.getElementById("message");

            if (response.ok) {
              const result = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;

              // Se puede limpiar el formulario y cerrar el modal luego de unos segundos
              setTimeout(() => {
                document.getElementById("insertarAuditorForm").reset();
                let modalEl = document.getElementById("modalInsertarAuditor");
                let modalInstance = bootstrap.Modal.getInstance(modalEl);
                //modalInstance.hide();
                messageDiv.innerHTML = "";
              }, 2000);
            } else {
              // En caso de error, mostramos el mensaje recibido
              const error = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
          } catch (err) {
            console.error("Error al insertar auditor:", err);
            document.getElementById("message").innerHTML =
              '<div class="alert alert-danger">Error en la conexión al servidorr.</div>';
          }
        });
    </script>
    <script>
      // Función para obtener los datos del backend
      async function cargarAuditores() {
          try {
              // Realizamos una solicitud GET al backend
              const response = await fetch('http://localhost:3000/auditores'); // Reemplaza con la URL correcta
              const auditores = await response.json();

              // Referencia al cuerpo de la tabla
              const tabla = document.querySelector('#tabla-Auditors tbody');
              tabla.innerHTML = ''; // Limpiamos la tabla antes de llenarla

              // Iteramos sobre los Auditors y agregamos filas a la tabla
              auditores.forEach(Auditor => {
                  const fila = `
                      <tr>
                          <td>${Auditor.AUDITOR_ID}</td>
                          <td>${Auditor.NOMBRE}</td>
                          <td>${Auditor.APELLIDO}</td>
                          <td>${Auditor.EMAIL}</td>
                          <td>${Auditor.TELEFONO}</td>
                          
                          <td>
                              <button class="btn btn-danger" onclick="eliminarAuditor(${Auditor.AUDITOR_ID})">Eliminar</button>
                          </td>
                      </tr>
                  `;
                  tabla.innerHTML += fila;
              });
          } catch (error) {
              console.error('Error al cargar auditores:', error);
          }
      }

      // Función para eliminar un auditor
      async function eliminarAuditor(auditorID) {
        if (confirm('¿Estás seguro de que quieres eliminar este auditor?')) {
            try {
                const response = await fetch(`http://localhost:3000/eliminar-auditor/${auditorID}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('auditor eliminado exitosamente.');
                    cargarAuditores(); // Refrescar la tabla después de eliminar
                } else {
                    alert('Error al eliminar auditor seleccionado.');
                }
            } catch (err) {
                console.error('Error al eliminar auditor:', err);
                alert('Error al eliminar auditor.');
            }
        }
    }
    

      // Cargar los auditores automáticamente al cargar la página
      window.onload = cargarAuditores;
  </script>
  <script>
    // Capturamos el envío del formulario para actualizar auditor
    document
      .getElementById("actualizarAuditorForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();
  
        const auditorID = document.getElementById("actualizarAuditorId").value;
        const nombre = document.getElementById("actualizarUserName").value;
        const apellido = document.getElementById("actualizarApellido").value;
        const email = document.getElementById("actualizarEmail").value;
        const telefono = document.getElementById("actualizartelefono").value;
        
  
        const data = {
          auditorID: Number(auditorID),
          nombre: nombre,
          apellido: apellido,
          email: email,
          telefono: telefono,
        };
  
        try {
          const response = await fetch("http://localhost:3000/actualizar-auditor", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
  
          if (response.ok) {
            alert("auditor actualizado correctamente.");
            document.getElementById("actualizarAuditorForm").reset();
            let modalEl = document.getElementById("modalActualizarAuditor");
            let modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();
            cargarAuditores(); // Refrescar la tabla de auditores
          } else {
            const error = await response.json();
            alert(error.message);
          }
        } catch (err) {
          console.error("Error al actualizar auditor:", err);
          alert("Error en la conexión al servidor.");
        }
      });
  </script>
  </body>
</html>
