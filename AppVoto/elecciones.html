<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insertar Eleccion</title>
    <!-- Bootstrap CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Botón para abrir el modal de insertar Eleccion-->
    <div class="container mt-5">
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#modalInsertarEleccion"
      >
        Insertar
      </button>
       <button type="button" class="btn btn-success ms-3" onclick="cargarElecciones()">Refrescar Datos</button>
    </div>

    <!-- Modal para insertar Eleccion -->
    <div
      class="modal fade"
      id="modalInsertarEleccion"
      tabindex="-1"
      aria-labelledby="modalInsertarEleccionLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalInsertarEleccionLabel">
              Insertar Nueva Eleccion
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="insertarEleccionForm">
              <div class="mb-3">
                <label for="name" class="form-label">Nombre</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                <input
                  type="text"
                  class="form-control"
                  id="fecha_inicio"
                  name="fecha_inicio"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="fecha_fin" class="form-label">Fecha Cierre</label>
                <input
                  type="date"
                  class="form-control"
                  id="fecha_fin"
                  name="fecha_fin"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="descripcion" class="form-label">Descripcion</label>
                <input
                  type="text"
                  class="form-control"
                  id="descripcion"
                  name="descripcion"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="estadoID" class="form-label">Estado ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="estadoID"
                  name="estadoID"
                  required
                />
              </div>
              <!-- Área para mensajes (éxito/error) -->
              
              <div id="message"></div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  Insertar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Botón para abrir el modal de actualizar Eleccion -->
<div class="container mt-5">
  <button
    type="button"
    class="btn btn-warning"
    data-bs-toggle="modal"
    data-bs-target="#modalActualizarEleccion"
  >
    Actualizar Eleccion
  </button>
</div>

<!-- Modal para actualizar Eleccion -->
<div
  class="modal fade"
  id="modalActualizarEleccion"
  tabindex="-1"
  aria-labelledby="modalActualizarEleccionLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalActualizarEleccionLabel">
          Actualizar Eleccion
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <form id="actualizarEleccionForm">
          <div class="mb-3">
            <label for="actualizarEleccionId" class="form-label">EleccionID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarEleccionId"
              name="EleccionId"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarname" class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              id="actualizarname"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarfecha_inicio" class="form-label">fecha_inicio</label>
            <input
              type="text"
              class="form-control"
              id="actualizarfecha_inicio"
              name="fecha_inicio"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarfecha_fin" class="form-label">fecha_fin</label>
            <input
              type="date"
              class="form-control"
              id="actualizarfecha_fin"
              name="fecha_fin"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizardescripcion" class="form-label">descripcion</label>
            <input
              type="text"
              class="form-control"
              id="actualizardescripcion"
              name="descripcion"
              required
            />
          </div> 
          <div class="mb-3">
            <label for="estadoID" class="form-label">Estado ID</label>
            <input
              type="number"
              class="form-control"
              id="estadoID"
              name="estadoID"
              required
            />
          </div>         
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-warning">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
    <div class="container mt-4">
      <h3 class="text-center">Lista de Elecciones</h3>
      <table class="table table-bordered" id="tabla-Eleccions">
          <thead>
              <tr>
                  <th>EleccionID</th>
                  <th>Nombre</th>
                  <th>fecha_inicio</th>
                  <th>fecha_fin</th>
                  <th>descripcion</th>
                  <th>Eleccion_ID</th>
              </tr>
          </thead>
          <tbody>
              <!-- Aquí se cargarán los datos dinámicamente -->
          </tbody>
      </table>
  </div>

    <!-- Bootstrap Bundle JS (con Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Capturamos el envío del formulario
      document
        .getElementById("insertarEleccionForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Recuperamos los datos del formulario
          const nombre = document.getElementById("name").value;
          const fecha_inicio = document.getElementById("fecha_inicio").value;
          const fecha_fin = document.getElementById("fecha_fin").value;
          const descripcion = document.getElementById("descripcion").value;
          const estadoID = document.getElementById("estadoID").value;
          
          
          // Preparamos el objeto de datos
          const data = {
            
            nombre: nombre,
            fecha_inicio: fecha_inicio,
            fecha_fin: fecha_fin,
            descripcion: descripcion,
            estadoID: estadoID,
            
          };

          try {
            // Llamada al endpoint que ejecuta el procedimiento almacenado
            
            const response = await fetch("http://localhost:3000/insertar-eleccion", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const messageDiv = document.getElementById("message");

            if (response.ok) {
              const result = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;

              // Se puede limpiar el formulario y cerrar el modal luego de unos segundos
              setTimeout(() => {
                document.getElementById("insertarEleccionForm").reset();
                let modalEl = document.getElementById("modalInsertarEleccion");
                let modalInstance = bootstrap.Modal.getInstance(modalEl);
                //modalInstance.hide();
                messageDiv.innerHTML = "";
              }, 2000);
            } else {
              // En caso de error, mostramos el mensaje recibido
              const error = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
          } catch (err) {
            console.error("Error al insertar Eleccion:", err);
            document.getElementById("message").innerHTML =
              '<div class="alert alert-danger">Error en la conexión al servidorr.</div>';
          }
        });
    </script>
    <script>
      // Función para obtener los datos del backend
      async function cargarElecciones() {
          try {
              // Realizamos una solicitud GET al backend
              const response = await fetch('http://localhost:3000/elecciones'); // Reemplaza con la URL correcta
              const Elecciones = await response.json();

              // Referencia al cuerpo de la tabla
              const tabla = document.querySelector('#tabla-Eleccions tbody');
              tabla.innerHTML = ''; // Limpiamos la tabla antes de llenarla

              // Iteramos sobre los Eleccions y agregamos filas a la tabla
              Elecciones.forEach(Eleccion => {
                  const fila = `
                      <tr>
                          <td>${Eleccion.Eleccion_ID}</td>
                          <td>${Eleccion.NOMBRE}</td>
                          <td>${Eleccion.fecha_inicio}</td>
                          <td>${Eleccion.fecha_fin}</td>
                          <td>${Eleccion.descripcion}</td>
                          <td>${Eleccion.estadoID}</td>
                          
                          <td>
                              <button class="btn btn-danger" onclick="eliminarEleccion(${Eleccion.Eleccion_ID})">Eliminar</button>
                          </td>
                      </tr>
                  `;
                  tabla.innerHTML += fila;
              });
          } catch (error) {
              console.error('Error al cargar Elecciones:', error);
          }
      }

      // Función para eliminar un Eleccion
      async function eliminarEleccion(EleccionID) {
        if (confirm('¿Estás seguro de que quieres eliminar este Eleccion?')) {
            try {
                const response = await fetch(`http://localhost:3000/eliminar-eleccion/${EleccionID}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('Eleccion eliminado exitosamente.');
                    cargarElecciones(); // Refrescar la tabla después de eliminar
                } else {
                    alert('Error al eliminar Eleccion seleccionado.');
                }
            } catch (err) {
                console.error('Error al eliminar Eleccion:', err);
                alert('Error al eliminar Eleccion.');
            }
        }
    }
    

      // Cargar los Elecciones automáticamente al cargar la página
      window.onload = cargarElecciones;
  </script>
  <script>
    // Capturamos el envío del formulario para actualizar Eleccion
    document
      .getElementById("actualizarEleccionForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();
  
        const EleccionID = document.getElementById("actualizarEleccionId").value;
        const nombre = document.getElementById("actualizarname").value;
        const fecha_inicio = document.getElementById("actualizarfecha_inicio").value;
        const fecha_fin = document.getElementById("actualizarfecha_fin").value;
        const descripcion = document.getElementById("actualizardescripcion").value;
        
  
        const data = {
          EleccionID: Number(EleccionID),
          nombre: nombre,
          fecha_inicio: fecha_inicio,
          fecha_fin: fecha_fin,
          descripcion: descripcion,
        };
  
        try {
          const response = await fetch("http://localhost:3000/actualizar-eleccion", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
  
          if (response.ok) {
            alert("Eleccion actualizado correctamente.");
            document.getElementById("actualizarEleccionForm").reset();
            let modalEl = document.getElementById("modalActualizarEleccion");
            let modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();
            cargarElecciones(); // Refrescar la tabla de Elecciones
          } else {
            const error = await response.json();
            alert(error.message);
          }
        } catch (err) {
          console.error("Error al actualizar Eleccion:", err);
          alert("Error en la conexión al servidor.");
        }
      });
  </script>
  </body>
</html>
