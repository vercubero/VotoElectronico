<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insertar Usuario</title>
    <!-- Bootstrap CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Botón para abrir el modal de insertar usuario-->
    <div class="container mt-5">
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#modalInsertarUsuario"
      >
        Insertar Usuario
      </button>
       <button type="button" class="btn btn-success ms-3" onclick="cargarUsuarios()">Refrescar Datos</button>
    </div>

    <!-- Modal para insertar usuario -->
    <div
      class="modal fade"
      id="modalInsertarUsuario"
      tabindex="-1"
      aria-labelledby="modalInsertarUsuarioLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalInsertarUsuarioLabel">
              Insertar Nuevo Usuario
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <form id="insertarUsuarioForm">
              <div class="mb-3">
                <label for="userName" class="form-label">User Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="userName"
                  name="userName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  name="password"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="rolId" class="form-label">Rol ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="rolId"
                  name="rolId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="estadoId" class="form-label">Estado ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="estadoId"
                  name="estadoId"
                  required
                />
              </div>
            
              <!-- Área para mensajes (éxito/error) -->
              
              <div id="message"></div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                  Insertar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Botón para abrir el modal de actualizar usuario -->
<div class="container mt-5">
  <button
    type="button"
    class="btn btn-warning"
    data-bs-toggle="modal"
    data-bs-target="#modalActualizarUsuario"
  >
    Actualizar Usuario
  </button>
</div>

<!-- Modal para actualizar usuario -->
<div
  class="modal fade"
  id="modalActualizarUsuario"
  tabindex="-1"
  aria-labelledby="modalActualizarUsuarioLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalActualizarUsuarioLabel">
          Actualizar Usuario
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <form id="actualizarUsuarioForm">
          <div class="mb-3">
            <label for="actualizarUsuarioId" class="form-label">Usuario ID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarUsuarioId"
              name="usuarioId"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarUserName" class="form-label">User Name</label>
            <input
              type="text"
              class="form-control"
              id="actualizarUserName"
              name="userName"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarPassword" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="actualizarPassword"
              name="password"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="actualizarEmail"
              name="email"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarRolId" class="form-label">Rol ID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarRolId"
              name="rolId"
              required
            />
          </div>
          <div class="mb-3">
            <label for="actualizarEstadoId" class="form-label">Estado ID</label>
            <input
              type="number"
              class="form-control"
              id="actualizarEstadoId"
              name="estadoId"
              required
            />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-warning">Actualizar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
    <div class="container mt-4">
      <h3 class="text-center">Lista de Usuarios</h3>
      <table class="table table-bordered" id="tabla-usuarios">
          <thead>
              <tr>
                  <th>User_ID</th>
                  <th>User_Name</th>
                  <th>Password</th>
                  <th>Email</th>
                  <th>ROL_ID</th>
                  <th>Estado_ID</th>
              </tr>
          </thead>
          <tbody>
              <!-- Aquí se cargarán los datos dinámicamente -->
          </tbody>
      </table>
  </div>

    <!-- Bootstrap Bundle JS (con Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Capturamos el envío del formulario
      document
        .getElementById("insertarUsuarioForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Recuperamos los datos del formulario
          
          const userName = document.getElementById("userName").value;
          const password = document.getElementById("password").value;
          const email = document.getElementById("email").value;
          const rolId = document.getElementById("rolId").value;
          const estadoId = document.getElementById("estadoId").value;
          
          // Preparamos el objeto de datos
          const data = {
            
            userName: userName,
            password: password,
            email: email,
            rolId: Number(rolId),
            estadoId: Number(estadoId),
            
          };

          try {
            // Llamada al endpoint que ejecuta el procedimiento almacenado
            
            const response = await fetch("http://localhost:3000/insertar-usuario", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const messageDiv = document.getElementById("message");

            if (response.ok) {
              const result = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;

              // Se puede limpiar el formulario y cerrar el modal luego de unos segundos
              setTimeout(() => {
                document.getElementById("insertarUsuarioForm").reset();
                let modalEl = document.getElementById("modalInsertarUsuario");
                let modalInstance = bootstrap.Modal.getInstance(modalEl);
                //modalInstance.hide();
                messageDiv.innerHTML = "";
              }, 2000);
            } else {
              // En caso de error, mostramos el mensaje recibido
              const error = await response.json();
              messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
          } catch (err) {
            console.error("Error al insertar usuario:", err);
            document.getElementById("message").innerHTML =
              '<div class="alert alert-danger">Error en la conexión al servidorr.</div>';
          }
        });
    </script>
    <script>
      // Función para obtener los datos del backend
      async function cargarUsuarios() {
          try {
              // Realizamos una solicitud GET al backend
              const response = await fetch('http://localhost:3000/usuarios'); // Reemplaza con la URL correcta
              const usuarios = await response.json();

              // Referencia al cuerpo de la tabla
              const tabla = document.querySelector('#tabla-usuarios tbody');
              tabla.innerHTML = ''; // Limpiamos la tabla antes de llenarla

              // Iteramos sobre los usuarios y agregamos filas a la tabla
              usuarios.forEach(usuario => {
                  const fila = `
                      <tr>
                          <td>${usuario.USUARIO_ID}</td>
                          <td>${usuario.USER_NAME}</td>
                          <td>${usuario.PASSWORD}</td>
                          <td>${usuario.EMAIL}</td>
                          <td>${usuario.ROL_ID}</td>
                          <td>${usuario.ESTADO_ID}</td>
                          <td>
                              <button class="btn btn-danger" onclick="eliminarUsuario(${usuario.USUARIO_ID})">Eliminar</button>
                          </td>
                      </tr>
                  `;
                  tabla.innerHTML += fila;
              });
          } catch (error) {
              console.error('Error al cargar usuarios:', error);
          }
      }

      // Función para eliminar un usuario
      async function eliminarUsuario(usuarioId) {
        if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
            try {
                const response = await fetch(`http://localhost:3000/eliminar-usuario/${usuarioId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('Usuario eliminado exitosamente.');
                    cargarUsuarios(); // Refrescar la tabla después de eliminar
                } else {
                    alert('Error al eliminar usuario seleccionado.');
                }
            } catch (err) {
                console.error('Error al eliminar usuario:', err);
                alert('Error al eliminar usuario.');
            }
        }
    }
    

      // Cargar los usuarios automáticamente al cargar la página
      window.onload = cargarUsuarios;
  </script>
  <script>
    // Capturamos el envío del formulario para actualizar usuario
    document
      .getElementById("actualizarUsuarioForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();
  
        const usuarioId = document.getElementById("actualizarUsuarioId").value;
        const userName = document.getElementById("actualizarUserName").value;
        const password = document.getElementById("actualizarPassword").value;
        const email = document.getElementById("actualizarEmail").value;
        const rolId = document.getElementById("actualizarRolId").value;
        const estadoId = document.getElementById("actualizarEstadoId").value;
  
        const data = {
          usuarioId: Number(usuarioId),
          userName: userName,
          password: password,
          email: email,
          rolId: Number(rolId),
          estadoId: Number(estadoId),
        };
  
        try {
          const response = await fetch("http://localhost:3000/actualizar-usuario", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
  
          if (response.ok) {
            alert("Usuario actualizado correctamente.");
            document.getElementById("actualizarUsuarioForm").reset();
            let modalEl = document.getElementById("modalActualizarUsuario");
            let modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();
            cargarUsuarios(); // Refrescar la tabla de usuarios
          } else {
            const error = await response.json();
            alert(error.message);
          }
        } catch (err) {
          console.error("Error al actualizar usuario:", err);
          alert("Error en la conexión al servidor.");
        }
      });
  </script>
  </body>
</html>
